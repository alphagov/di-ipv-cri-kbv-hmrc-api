{
  "Comment": "Return any unanswered question if available.",
  "StartAt": "Get NINO",
  "States": {
    "Get NINO": {
      "Type": "Task",
      "Parameters": {
        "TableName": "${PersonIdentityTableName}",
        "KeyConditionExpression": "sessionId = :value",
        "ExpressionAttributeValues": {
          ":value": {
            "S.$": "$.sessionId"
          }
        }
      },
      "Resource": "arn:aws:states:::aws-sdk:dynamodb:query",
      "ResultPath": "$.nino",
      "Next": "Check NINO field present"
    },
    "Check NINO field present": {
      "Type": "Choice",
      "Choices": [
        {
          "Not": {
            "Variable": "$.nino.Count",
            "NumericGreaterThan": 0
          },
          "Next": "Err: Missing nino"
        }
      ],
      "Default": "Get Unanswered question set"
    },
    "Err: Missing nino": {
      "Type": "Fail",
      "Cause": "No NINO found for given session-id"
    },
    "Get Unanswered question set": {
      "Type": "Task",
      "Next": "Check if we have any unanswered questions",
      "Parameters": {
        "TableName": "${QuestionsTableName}",
        "KeyConditionExpression": "sessionId = :value",
        "ExpressionAttributeValues": {
          ":value": {
            "S.$": "$.sessionId"
          }
        }
      },
      "Resource": "arn:aws:states:::aws-sdk:dynamodb:query",
      "OutputPath": "$.Items[0].questions.L[?(@.M.answered.Bool==false)].M"
    },
    "Check if we have any unanswered questions": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$[0]",
          "IsPresent": true,
          "Next": "Iterate over questions"
        }
      ],
      "Default": "204: No More Questions"
    },
    "Iterate over questions": {
      "Type": "Map",
      "ItemProcessor": {
        "ProcessorConfig": {
          "Mode": "INLINE"
        },
        "StartAt": "Filter out dynamo artifacts",
        "States": {
          "Filter out dynamo artifacts": {
            "Type": "Pass",
            "Parameters": {
              "questionKey.$": "$.questionKey.S",
              "info.$": "$[?(@.info)].info.M",
              "order.$": "$.order.N",
              "answered.$": "$.answered.Bool",
              "infoCount.$": "States.ArrayLength($[?(@.info)].info.M)",
              "infoIsEmpty.$": "States.ArrayContains($[?(@.info)].info.M, '{}')"
            },
            "Next": "Choice"
          },
          "Choice": {
            "Type": "Choice",
            "Choices": [
              {
                "And": [
                  {
                    "Variable": "$.infoCount",
                    "NumericGreaterThan": 0
                  },
                  {
                    "Variable": "$.infoIsEmpty",
                    "BooleanEquals": false
                  }
                ],
                "Next": "Sanitise Info Array"
              }
            ],
            "Default": "Remove Info Object"
          },
          "Sanitise Info Array": {
            "Type": "Pass",
            "End": true,
            "Parameters": {
              "questionKey.$": "$.questionKey",
              "info": {
                "currentTaxYear.$": "States.ArrayGetItem($[?(@.info[0].currentTaxYear)].info[0].currentTaxYear.S,0)",
                "previousTaxYear.$": "States.ArrayGetItem($[?(@.info[0].previousTaxYear)].info[0].previousTaxYear.S,0)"
              },
              "order.$": "$.order",
              "answered.$": "$.answered"
            }
          },
          "Remove Info Object": {
            "Type": "Pass",
            "End": true,
            "Parameters": {
              "questionKey.$": "$.questionKey",
              "info": [],
              "order.$": "$.order",
              "answered.$": "$.answered"
            }
          }
        }
      },
      "Next": "Get next question",
      "MaxConcurrency": 1
    },
    "Get next question": {
      "Type": "Pass",
      "Next": "Return Next Question",
      "Parameters": {
        "questionKey.$": "$[0].questionKey",
        "info.$": "$[0].info"
      }
    },
    "Return Next Question": {
      "Type": "Pass",
      "End": true
    },
    "204: No More Questions": {
      "Type": "Pass",
      "End": true,
      "Parameters": 204
    }
  }
}
